<!DOCTYPE html>
<html>
<head>
    <title>CraveControl.org</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/bulma.css">
    <script type="text/javascript" src="js/app.js"></script>
    <style type="text/css">
        html {
            background:#EFEFEF;
        }
    </style>
</head>
<body>
</body>
    <audio id="ping"> <source src="https://www.freesound.org/data/previews/91/91926_7037-lq.mp3" type="audio/mpeg"> </audio>

    <script type="text/javascript">



        if(localStorage.getItem("token")==null){
          var token = "";
        } else {
          var token = JSON.parse(localStorage.getItem("token")).token;
        }


        var flags = {"token": token
                    , "time": Date.now()
                    }

        console.log(flags);

        var app = Elm.Main.fullscreen(flags);


        // File reader ports

        app.ports.fileSelected.subscribe(function (id){
            //https://www.paramander.com/blog/using-ports-to-deal-with-files-in-elm-0-17

            console.log(id);

            var node = document.getElementById(id);
            if (node === null){
                return;
            }
            var file = node.files[0];
            var reader = new FileReader();
            reader.onload = (function(event){
                // target is the file
                var base64encoded = event.target.result;
                var portData = {
                    upload: base64encoded,
                    userid: node.className
                };

                console.log(portData);

                // send file to elm port
                app.ports.fileContentRead.send(portData);
            });
            reader.readAsDataURL(file);

        });

        // Audio ports

        app.ports.playAudioPing.subscribe(function(model) {
            document.getElementById("ping").play()
        });

        // Local Storage Ports

        app.ports.storageGetItem.subscribe(function(key){
            app.ports.getUserResponse.send(localStorage.getItem(key) ? localStorage.getItem(key) : "");
        });

        app.ports.storageSetItem.subscribe(function(keyValue){
            var [key, value] = keyValue;
            setLocalStorageItem(key, value);
        });

        app.ports.storageRemoveItem.subscribe(function(key){
            localStorage.removeItem(key);
        });

        app.ports.storageClear.subscribe(function(i){
            localStorage.clear();
        });

        /**
         * Set a value of any type in localStorage.
         * (Serializes in JSON before storing since Storage objects can only hold strings.)
         *
         * @param {String} key   Key in localStorage
         * @param {*}      value The value to set
         */
        function setLocalStorageItem(key, value) {
          window.localStorage.setItem(key,
            JSON.stringify(value)
          );
        }



    </script>

</html>
