<!DOCTYPE html>
<html>
<head>
    <title>CraveControl.org</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/css/bulma.css">
    <script type="text/javascript" src="/js/app.js"></script>
    <style type="text/css">
        html {
            background:#EFEFEF;
        }
    </style>
</head>
<body>
</body>
    <audio id="ping"> <source src="https://www.freesound.org/data/previews/91/91926_7037-lq.mp3" type="audio/mpeg"> </audio>

    <script type="text/javascript">


        if(localStorage.getItem("token")==null){
          var token = "";
        } else {
          var token = JSON.parse(localStorage.getItem("token")).token;
        }


        var flags = {"token": token
                    , "time": Date.now()
                    }

        console.log(flags);

        var app = Elm.Main.fullscreen(flags);


        // File reader ports

        app.ports.fileSelected.subscribe(function (id){

            var node = document.getElementById(id);
            if (node === null){
                return;
            }
            var file = node.files[0];
            var reader = new FileReader();
            reader.onload = (function(event){
                // target is the file
                var csvFile = event.target.result;
                var portData = {
                    upload: csvFile,
                    userid: node.className
                };

                // send file to elm port
                app.ports.fileContentRead.send(portData);
            });

            reader.readAsText(file);

        });

        app.ports.uploadFile.subscribe(function(id, sub, token){

            var filePicker = document.getElementById(id);

            filePicker.addEventListener('change', function(e) {


                var file = this.files[0];
                var formData = new FormData();

                formData.append("upload", file);

                var xhr = new XMLHttpRequest();
                xhr.send(formData);

                // xhr.addEventListener('progress', function(e) {
                //     var done = e.position || e.loaded, total = e.totalSize || e.total;
                //     console.log('xhr progress: ' + (Math.floor(done/total*1000)/10) + '%');
                // }, false);

                // if ( xhr.upload ) {
                //     xhr.upload.onprogress = function(e) {
                //         var done = e.position || e.loaded, total = e.totalSize || e.total;
                //         console.log('xhr.upload progress: ' + done + ' / ' + total + ' = ' + (Math.floor(done/total*1000)/10) + '%');
                //     };
                // };

                xhr.onreadystatechange = function(e) {
                    if ( 4 == this.readyState ) {
                        console.log(['xhr upload complete', e]);
                    }
                };

                xhr.open('post', "http://localhost:8668/upload/ugimgset", true);
                xhr.setRequestHeader("Content-Type","multipart/form-data");
                xhr.setRequestHeader("Authorization", "Bearer " + token);

                // TODO add "userid" part

                xhr.send(file);

            }, false);

        });

        // Audio ports

        app.ports.playAudioPing.subscribe(function(nothing) {
            document.getElementById("ping").play();
        });

        // Local Storage Ports

        app.ports.storageGetItem.subscribe(function(key){
            app.ports.getUserResponse.send(localStorage.getItem(key) ? localStorage.getItem(key) : "");
        });

        app.ports.storageSetItem.subscribe(function(keyValue){
            var [key, value] = keyValue;
            setLocalStorageItem(key, value);
        });

        app.ports.storageRemoveItem.subscribe(function(key){
            localStorage.removeItem(key);
        });

        app.ports.storageClear.subscribe(function(i){
            localStorage.clear();
        });

        /**
         * Set a value of any type in localStorage.
         * (Serializes in JSON before storing since Storage objects can only hold strings.)
         *
         * @param {String} key   Key in localStorage
         * @param {*}      value The value to set
         */
        function setLocalStorageItem(key, value) {
          window.localStorage.setItem(key,
            JSON.stringify(value)
          );
        }

    </script>

</html>
